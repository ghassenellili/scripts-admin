name: Tests Avanc√©s

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1 : Tests de syntaxe
  syntax-check:
    name: V√©rification syntaxe
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: V√©rifier syntaxe Bash
        run: |
          echo "üîç V√©rification syntaxe..."
          for script in *.sh; do
            [ -f "$script" ] && bash -n "$script" && echo "‚úÖ $script"
          done

  # Job 2 : Tests de s√©curit√© (ShellCheck)
  security-check:
    name: Analyse de s√©curit√©
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Installer ShellCheck
        run: sudo apt-get install -y shellcheck
      
      - name: Analyser les scripts
        run: |
          echo "üîí Analyse de s√©curit√© avec ShellCheck..."
          for script in *.sh; do
            if [ -f "$script" ]; then
              echo "Analyse de $script..."
              shellcheck "$script" || true
            fi
          done

  # Job 3 : Tests d'ex√©cution
  execution-test:
    name: Tests d'ex√©cution
    runs-on: ubuntu-latest
    needs: [syntax-check, security-check]  # Attend les 2 premiers jobs
    steps:
      - uses: actions/checkout@v3
      
      - name: Rendre les scripts ex√©cutables
        run: chmod +x *.sh
      
      - name: Tester backup.sh
        run: |
          echo "üß™ Test de backup.sh..."
          # Test en mode dry-run ou avec des donn√©es de test
          bash backup.sh || echo "‚ö†Ô∏è backup.sh n√©cessite des ajustements"
      
      - name: Tester monitor.sh
        run: |
          echo "üß™ Test de monitor.sh..."
          bash monitor.sh

  # Job 4 : Rapport final
  report:
    name: Rapport de build
    runs-on: ubuntu-latest
    needs: [syntax-check, security-check, execution-test]
    if: always()  # S'ex√©cute m√™me si les autres jobs √©chouent
    steps:
      - name: G√©n√©rer le rapport
        run: |
          echo "üìä RAPPORT DE BUILD"
          echo "=================="
          echo "‚úÖ Build termin√©"
          echo "Date : $(date)"
          echo "Commit : ${{ github.sha }}"
          echo "Branche : ${{ github.ref }}"
