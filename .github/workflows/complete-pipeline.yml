name: Pipeline CI/CD Complet

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  RELEASE_NAME: scripts-admin
  SCRIPTS_DIR: ./

jobs:
  syntax-check:
    name: üîç V√©rification de la syntaxe
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Afficher les informations
        run: |
          echo "üìä Informations du build"
          echo "========================"
          echo "Branche : ${{ github.ref }}"
          echo "Commit : ${{ github.sha }}"
          echo "Auteur : ${{ github.actor }}"
          echo "========================"
      
      - name: Lister les fichiers
        run: |
          echo "üìÅ Fichiers dans le d√©p√¥t :"
          ls -lah
      
      - name: Tester la syntaxe Bash
        run: |
          echo "üîç PHASE 1 : V√©rification de la syntaxe"
          echo "========================================"
          
          total=0
          success=0
          failed=0
          
          for script in *.sh; do
            if [ -f "$script" ]; then
              total=$((total + 1))
              echo ""
              echo "üìÑ Test de : $script"
              
              if bash -n "$script" 2>&1; then
                echo "‚úÖ $script : Syntaxe correcte"
                success=$((success + 1))
              else
                echo "‚ùå $script : ERREUR DE SYNTAXE"
                failed=$((failed + 1))
              fi
            fi
          done
          
          echo ""
          echo "========================================"
          echo "üìä R√âSUM√â DES TESTS DE SYNTAXE"
          echo "========================================"
          echo "Total de scripts test√©s : $total"
          echo "‚úÖ R√©ussis : $success"
          echo "‚ùå √âchou√©s : $failed"
          echo "========================================"
          
          if [ $failed -gt 0 ]; then
            echo "‚ùå Des erreurs de syntaxe ont √©t√© d√©tect√©es !"
            exit 1
          fi
          
          echo "‚úÖ Tous les scripts ont une syntaxe correcte !"

  permissions-check:
    name: üîê V√©rification des permissions
    runs-on: ubuntu-latest
    needs: syntax-check
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: V√©rifier les permissions ex√©cutables
        run: |
          echo "üîê PHASE 2 : V√©rification des permissions"
          echo "=========================================="
          
          total=0
          executable=0
          not_executable=0
          
          for script in *.sh; do
            if [ -f "$script" ]; then
              total=$((total + 1))
              
              if [ -x "$script" ]; then
                echo "‚úÖ $script : ex√©cutable"
                executable=$((executable + 1))
              else
                echo "‚ö†Ô∏è  $script : NON ex√©cutable"
                not_executable=$((not_executable + 1))
              fi
            fi
          done
          
          echo ""
          echo "=========================================="
          echo "üìä R√âSUM√â DES PERMISSIONS"
          echo "=========================================="
          echo "Total de scripts : $total"
          echo "‚úÖ Ex√©cutables : $executable"
          echo "‚ö†Ô∏è  Non ex√©cutables : $not_executable"
          echo "=========================================="
          
          if [ $not_executable -gt 0 ]; then
            echo "‚ö†Ô∏è  Attention : Certains scripts ne sont pas ex√©cutables"
            echo "üí° Conseil : Utilisez 'chmod +x *.sh'"
          else
            echo "‚úÖ Tous les scripts sont ex√©cutables !"
          fi

  unit-tests:
    name: üß™ Tests unitaires
    runs-on: ubuntu-latest
    needs: [syntax-check, permissions-check]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Pr√©parer l'environnement de test
        run: |
          echo "üß™ PHASE 3 : Tests unitaires"
          echo "=========================================="
          mkdir -p test-env
          cd test-env
          echo "Contenu de test" > test-file.txt
          echo "Log de test" > test.log
          mkdir -p test-backup
          echo "‚úÖ Environnement de test cr√©√©"
      
      - name: Test 1 - Lisibilit√© des scripts
        run: |
          echo ""
          echo "üìã Test 1 : Lisibilit√© des scripts"
          for script in *.sh; do
            if [ -f "$script" ]; then
              if [ -r "$script" ]; then
                echo "‚úÖ $script est lisible"
              else
                echo "‚ùå $script n'est pas lisible"
                exit 1
              fi
            fi
          done
      
      - name: Test 2 - Pr√©sence du shebang
        run: |
          echo ""
          echo "üìã Test 2 : Pr√©sence du shebang"
          failed=0
          for script in *.sh; do
            if [ -f "$script" ]; then
              if echo "$first_line" | grep -q "^#!/bin/bash"; then
                echo "‚ö†Ô∏è  $script : shebang manquant"
                failed=1
            fi
            echo "‚ö†Ô∏è  Certains scripts n'ont pas de shebang"
          fi
      - name: Test 3 - Commandes dangereuses
        run: |
          echo "üìã Test 3 : D√©tection de commandes dangereuses"
          dangerous_found=0
          for script in *.sh; do
              if grep -q "rm -rf /" "$script" 2>/dev/null; then
                echo "‚ö†Ô∏è  $script contient 'rm -rf /'"
                dangerous_found=1
              fi
              if grep -q "mkfs" "$script" 2>/dev/null; then
                echo "‚ö†Ô∏è  $script contient 'mkfs'"
                dangerous_found=1
              fi
            fi
          if [ $dangerous_found -eq 0 ]; then
            echo "‚úÖ Aucune commande dangereuse d√©tect√©e"
          else
            echo "‚ö†Ô∏è  Commandes dangereuses d√©tect√©es"
          fi
      
      - name: Test 4 - Simulation d'ex√©cution
        run: |
          echo ""
          echo "üìã Test 4 : Simulation d'ex√©cution"
          chmod +x *.sh 2>/dev/null || true
          if [ -f "monitor.sh" ]; then
            echo "üß™ Test de monitor.sh..."
            timeout 5 bash monitor.sh > /tmp/output.txt 2>&1 || true
            echo "‚úÖ monitor.sh test√©"
          fi
          echo "‚úÖ Tests de simulation termin√©s"
      
      - name: R√©sum√© des tests
        run: |
          echo ""
          echo "=========================================="
          echo "üìä R√âSUM√â DES TESTS UNITAIRES"
          echo "=========================================="
          echo "‚úÖ Test 1 : Lisibilit√© - PASS√â"
          echo "‚úÖ Test 2 : Shebang - V√âRIFI√â"
          echo "‚úÖ Test 3 : S√©curit√© - ANALYS√â"
          echo "‚úÖ Test 4 : Ex√©cution - SIMUL√â"
          echo "=========================================="

  quality-check:
    name: üìä Analyse de qualit√©
    runs-on: ubuntu-latest
    needs: unit-tests
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Installer ShellCheck
        run: |
          echo "üì• Installation de ShellCheck..."
          sudo apt-get update -qq
          sudo apt-get install -y shellcheck
      
      - name: Analyser avec ShellCheck
        run: |
          echo "üîç Analyse de qualit√©"
          for script in *.sh; do
            if [ -f "$script" ]; then
              echo "üìÑ Analyse de $script..."
              shellcheck "$script" || true
            fi
          done
          echo "‚úÖ Analyse termin√©e"
        continue-on-error: true

  create-release:
    name: üì¶ Cr√©ation de la release
    runs-on: ubuntu-latest
    needs: [syntax-check, permissions-check, unit-tests, quality-check]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Pr√©parer la release
        id: prepare
        run: |
          echo "üì¶ Pr√©paration de la release..."
          mkdir -p release
          cp *.sh release/ 2>/dev/null || true
          cp README.md release/ 2>/dev/null || true
          DATE=$(date +%Y.%m.%d-%H%M)
          echo "VERSION=$DATE" >> $GITHUB_OUTPUT
          echo "$DATE" > release/VERSION.txt
          cat > release/BUILD-INFO.txt << EOF
          Build Information
          Date: $(date)
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref }}
          Author: ${{ github.actor }}
          EOF
          echo "‚úÖ Release pr√©par√©e"
      
      - name: Cr√©er l'archive
        run: |
          echo "üóúÔ∏è  Cr√©ation de l'archive..."
          VERSION=${{ steps.prepare.outputs.VERSION }}
          ARCHIVE_NAME="${RELEASE_NAME}-${VERSION}.tar.gz"
          tar -czf "$ARCHIVE_NAME" release/
          echo "üì¶ Archive cr√©√©e : $ARCHIVE_NAME"
          ls -lh "$ARCHIVE_NAME"
          echo "ARCHIVE_NAME=$ARCHIVE_NAME" >> $GITHUB_ENV
      
      - name: Upload de la release
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.RELEASE_NAME }}-release
          path: ${{ env.ARCHIVE_NAME }}
          retention-days: 90
      
      - name: Message de succ√®s
        run: |
          echo "=========================================="
          echo "üéâ RELEASE CR√â√âE AVEC SUCC√àS !"
          echo "=========================================="
          echo "üì¶ Archive : ${{ env.ARCHIVE_NAME }}"
          echo "=========================================="

  notification:
    name: üì¢ Notification finale
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always()
    
    steps:
      - name: V√©rifier le statut
        run: |
          echo "üìä RAPPORT FINAL DU PIPELINE"
          echo "============================"
          if [ "${{ needs.create-release.result }}" == "success" ]; then
            echo "‚úÖ Pipeline termin√© avec SUCC√àS"
          else
            echo "‚ö†Ô∏è  Pipeline termin√©"
          fi
          echo "Branche : ${{ github.ref }}"
          echo "Commit : ${{ github.sha }}"
          echo "============================"          done
            if [ -f "$script" ]; then
          echo ""
      
          if [ $failed -eq 1 ]; then
          done
              fi
              else
                echo "‚úÖ $script : shebang pr√©sent"

