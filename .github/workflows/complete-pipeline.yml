name: Pipeline CI/CD Complet

# D√©clencheurs
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # Permet de d√©clencher manuellement

# Variables d'environnement globales
env:
  RELEASE_NAME: scripts-admin
  SCRIPTS_DIR: .

jobs:
  # ========================================
  # JOB 1 : TESTS DE SYNTAXE
  # ========================================
  syntax-check:
    name: üîç V√©rification de la syntaxe
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Afficher les informations
        run: |
          echo "üìä Informations du build"
          echo "========================"
          echo "Branche : ${{ github.ref }}"
          echo "Commit : ${{ github.sha }}"
          echo "Auteur : ${{ github.actor }}"
          echo "========================"
      
      - name: Lister les fichiers
        run: |
          echo "üìÅ Fichiers dans le d√©p√¥t :"
          ls -lah
      
      - name: Tester la syntaxe Bash
        run: |
          echo "üîç PHASE 1 : V√©rification de la syntaxe"
          echo "========================================"
          
          # Compteurs
          total=0
          success=0
          failed=0
          
          # Parcourir tous les scripts .sh
          for script in *.sh; do
            if [ -f "$script" ]; then
              total=$((total + 1))
              echo ""
              echo "üìÑ Test de : $script"
              
              # V√©rifier la syntaxe avec bash -n
              if bash -n "$script" 2>&1; then
                echo "‚úÖ $script : Syntaxe correcte"
                success=$((success + 1))
              else
                echo "‚ùå $script : ERREUR DE SYNTAXE"
                failed=$((failed + 1))
              fi
            fi
          done
          
          # R√©sum√©
          echo ""
          echo "========================================"
          echo "üìä R√âSUM√â DES TESTS DE SYNTAXE"
          echo "========================================"
          echo "Total de scripts test√©s : $total"
          echo "‚úÖ R√©ussis : $success"
          echo "‚ùå √âchou√©s : $failed"
          echo "========================================"
          
          # √âchouer si au moins un script a une erreur
          if [ $failed -gt 0 ]; then
            echo "‚ùå Des erreurs de syntaxe ont √©t√© d√©tect√©es !"
            exit 1
          fi
          
          echo "‚úÖ Tous les scripts ont une syntaxe correcte !"

  # ========================================
  # JOB 2 : V√âRIFICATION DES PERMISSIONS
  # ========================================
  permissions-check:
    name: üîê V√©rification des permissions
    runs-on: ubuntu-latest
    needs: syntax-check  # Attend que syntax-check soit termin√©
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: V√©rifier les permissions ex√©cutables
        run: |
          echo "üîê PHASE 2 : V√©rification des permissions"
          echo "=========================================="
          
          # Compteurs
          total=0
          executable=0
          not_executable=0
          
          # Parcourir tous les scripts .sh
          for script in *.sh; do
            if [ -f "$script" ]; then
              total=$((total + 1))
              
              if [ -x "$script" ]; then
                echo "‚úÖ $script : ex√©cutable"
                executable=$((executable + 1))
              else
                echo "‚ö†Ô∏è  $script : NON ex√©cutable"
                not_executable=$((not_executable + 1))
              fi
            fi
          done
          
          # R√©sum√©
          echo ""
          echo "=========================================="
          echo "üìä R√âSUM√â DES PERMISSIONS"
          echo "=========================================="
          echo "Total de scripts : $total"
          echo "‚úÖ Ex√©cutables : $executable"
          echo "‚ö†Ô∏è  Non ex√©cutables : $not_executable"
          echo "=========================================="
          
          # Warning mais pas d'√©chec (car on peut rendre ex√©cutable apr√®s)
          if [ $not_executable -gt 0 ]; then
            echo "‚ö†Ô∏è  Attention : Certains scripts ne sont pas ex√©cutables"
            echo "üí° Conseil : Utilisez 'chmod +x *.sh' pour les rendre ex√©cutables"
          else
            echo "‚úÖ Tous les scripts sont ex√©cutables !"
          fi

  # ========================================
  # JOB 3 : TESTS UNITAIRES
  # ========================================
  unit-tests:
    name: üß™ Tests unitaires
    runs-on: ubuntu-latest
    needs: [syntax-check, permissions-check]
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4
      
      - name: Pr√©parer l'environnement de test
        run: |
          echo "üß™ PHASE 3 : Tests unitaires"
          echo "=========================================="
          
          # Cr√©er un environnement de test
          mkdir -p test-env
          cd test-env
          
          # Cr√©er des fichiers de test
          echo "Contenu de test" > test-file.txt
          echo "Log de test" > test.log
          mkdir -p test-backup
          
          echo "‚úÖ Environnement de test cr√©√©"
      
      - name: Test 1 - V√©rifier que les scripts sont lisibles
        run: |
          echo ""
          echo "üìã Test 1 : Lisibilit√© des scripts"
          for script in *.sh; do
            if [ -f "$script" ]; then
              if [ -r "$script" ]; then
                echo "‚úÖ $script est lisible"
              else
                echo "‚ùå $script n'est pas lisible"
                exit 1
              fi
            fi
          done
      
      - name: Test 2 - V√©rifier la pr√©sence du shebang
        run: |
          echo ""
          echo "üìã Test 2 : Pr√©sence du shebang (#!/bin/bash)"
          
          failed=0
          for script in *.sh; do
            if [ -f "$script" ]; then
              first_line=$(head -n 1 "$script")
              if [[ "$first_line" == "#!/bin/bash"* ]]; then
                echo "‚úÖ $script : shebang pr√©sent"
              else
                echo "‚ùå $script : shebang manquant ou incorrect"
                echo "   Premi√®re ligne : $first_line"
                failed=1
              fi
            fi
          done
          
          if [ $failed -eq 1 ]; then
            echo "‚ö†Ô∏è  Certains scripts n'ont pas de shebang correct"
            # Ne pas √©chouer pour ce test (juste un warning)
          fi
      
      - name: Test 3 - V√©rifier l'absence de commandes dangereuses
        run: |
          echo ""
          echo "üìã Test 3 : D√©tection de commandes dangereuses"
          
          echo "üîç Recherche de commandes potentiellement dangereuses..."
          
          # Liste de patterns √† rechercher
          if grep -r "rm -rf /" *.sh 2>/dev/null; then
            echo "‚ö†Ô∏è  Commande 'rm -rf /' trouv√©e"
          fi
          
          if grep -r "mkfs" *.sh 2>/dev/null; then
            echo "‚ö†Ô∏è  Commande 'mkfs' trouv√©e"
          fi
          
          if grep -r "> /dev/sd" *.sh 2>/dev/null; then
            echo "‚ö†Ô∏è  √âcriture directe sur disque d√©tect√©e"
          fi
          
          echo "‚úÖ Analyse de s√©curit√© termin√©e"
